<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro Targeting</title>
    <script type="text/javascript" src="Resources/js/configs.js"></script>
    <script type="text/javascript" src="Resources/js/shp.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>

<body class="bg-secondary bg-gradient">
    <div class="container-fluid vh-100 vw-100 d-flex flex-column p-4">
        <!-- filters section -->
        <div class="row flex-shrink-1 px-2 pb-4">
            <div class="column d-flex flex-row justify-content-start">
                <div class="btn-group mx-2">
                    <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuCategory"
                        data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        Category
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuCategory" id="categoryItem">
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                    </ul>
                </div>
                <div class="btn-group mx-2">
                    <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuCategorySquare"
                        data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        Category Square
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuCategorySquare" id="squareCategoryItem">
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                    </ul>
                </div>
                <div class="btn-group mx-2">
                    <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuSquareSegmentation"
                        data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        Square Segmentation
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuSquareSegmentation" id="squareSegmentItem">
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                    </ul>
                </div>
                <div class="btn-group mx-2">
                    <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuCluster"
                        data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        Region/Cluster/Sub Cluster
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuCluster" id="clusterItem">
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                    </ul>
                </div>
                <div class="btn-group mx-2">
                    <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuChannel"
                        data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        Channel
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuChannel" id="channelItem">
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                    </ul>
                </div>
                <div class="btn-group mx-2">
                    <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuBrand"
                        data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        Brand/SKU
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuBrand" id="brandItem">
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                    </ul>
                </div>
                <div class="btn-group mx-2">
                    <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuSquare"
                        data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                        Square ID
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuSquare" id="squareItem">
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                        <li><a class="dropdown-item" href="#">Menu item</a></li>
                    </ul>
                </div>
            </div>


        </div>

        <!-- main content sections -->
        <div class="row flex-grow-1 px-2">

            <!-- map section -->
            <div class="col-5 border" id="map"></div>

            <!-- data sections -->
            <div class="col-7 ps-4 d-flex flex-column">
                <!-- data summary section -->
                <div class="row flex-grow-1 pb-2">
                    <!-- section: Volume Sales -->
                    <div class="col d-flex flex-column bg-light">
                        <div class="row flex-shrink-1 p-2">
                            <div class="text-center h3 flex-grow-1">Volume Sales</div>
                        </div>
                        <div class="row flex-grow-1"></div>
                        <div class="row flex-grow-1"></div>
                    </div>
                    <!-- section: Stock Condition -->
                    <div class="col d-flex flex-column bg-light mx-2">
                        <div class="row flex-shrink-1 p-2">
                            <div class="text-center h3 flex-grow-1">Stock Condition</div>
                        </div>
                        <div class="row flex-grow-1"></div>
                    </div>
                    <!-- section: Distribution -->
                    <div class="col d-flex flex-column bg-light">
                        <div class="row flex-shrink-1 p-2">
                            <div class="text-center h3 flex-grow-1">Distribution</div>
                        </div>
                        <div class="row flex-grow-1"></div>
                        <div class="row flex-grow-1"></div>
                    </div>
                </div>
                <!-- data detail section -->
                <div class="row flex-grow-1 pt-2 px-2">
                    <div class="col p-2 bg-light">
                        <nav aria-label="...">
                            <ul class="pagination pagination-sm">
                                <li class="page-item active" aria-current="page">
                                    <a class="page-link" href="#" id="volume_link">Volume</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#" id="dropsize_link">Dropsize</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#" id="ec_link">Effective Call (%)</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#" id="active_outlet_link">Active Outlet (%)</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#" id="cum_dis_link">Cumulative Distribution</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#" id="square_summary_link">Square Summary</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#" id="jti_store_link">JTI Store</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#" id="idm_store_link">IDM Store</a>
                                </li>
                            </ul>
                        </nav>
                        <canvas class="text-reset" id="volume_page">

                        </canvas>
                        <canvas class="d-none text-reset" id="dropsize_page">
                            
                        </canvas>
                        <canvas class="d-none text-reset" id="ec_page">
                            Content: Effective Call (%)
                        </canvas>
                        <canvas class="d-none text-reset" id="active_outlet_page">
                            Content: Active Outlet (%)
                        </canvas>
                        <canvas class="d-none text-reset" id="cum_dis_page">
                            Content: Cumulative Distribution
                        </canvas>
                        <canvas class="d-none text-reset" id="square_summary_page">
                            Content: Square Summary
                        </canvas>
                        <canvas class="d-none text-reset" id="jti_store_page">
                            Content: JTI Store
                        </canvas>
                        <canvas class="d-none text-reset" id="idm_store_page">
                            Content: IDM Store
                        </canvas>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>/** FUNCTIONS **/

        /** 
         * loadScript is function to add script tag or link tag in html head 
         * @param src : url to source file
         * @param elm : type 
        **/
        async function loadScript(src, elm) {
            try {
                let script;
                switch (elm) {
                    case 1:
                        script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = src;
                        break;
                    case 2:
                        script = document.createElement('link');
                        script.rel = "stylesheet";
                        script.type = "text/css";
                        script.href = src;
                        break;
                    case 3:
                        script = document.createElement('link');
                        script.rel = "icon";
                        script.type = "image/png";
                        script.href = src;
                        break;
                    default: console.error('script not defined.');
                }
                await document.head.appendChild(script);
            } catch (err) {
                console.error('Script failed to load: ' + err.message);
            }
        }

        function loadDataWorker() {
            try {
                if (window.Worker) {
                    loadWorker = new Worker(siteConfig.siteResourceFolder.javascript + '/loadPoint.js');

                    // Calling Web Worker to load IDM POINT
                    loadWorker.postMessage([
                        'IDM POINT',
                        siteConfig.siteAddress +
                        siteConfig.siteDataFolder +
                        dataSource._point.idmPointjson,
                        'json',
                        true
                    ]);

                    // Calling Web Worker to load IDM TRX
                    loadWorker.postMessage([
                        'IDM TRX',
                        siteConfig.siteAddress +
                        siteConfig.siteDataFolder +
                        dataSource._transaction.idm
                        , 'json', false
                    ]);

                    // Calling Web Worker to load JTI POINT
                    loadWorker.postMessage([
                        'JTI POINT',
                        siteConfig.siteAddress +
                        siteConfig.siteDataFolder +
                        dataSource._point.jtiPointjson +
                        wpCode + '.json'
                        , 'json', true, 'szlatitude', 'szlongitude', 1
                    ]);

                    // Calling Web Worker to load JTI TRX
                    loadWorker.postMessage([
                        'JTI TRX',
                        siteConfig.siteAddress +
                        siteConfig.siteDataFolder +
                        dataSource._transaction.bosnet +
                        wpCode + '.json'
                        , 'json', false
                    ]);

                    // Calling Web Worker to load JTI TRX L4W
                    loadWorker.postMessage([
                        'JTI TRX L4W',
                        siteConfig.siteAddress +
                        siteConfig.siteDataFolder +
                        dataSource._transaction.l4w +
                        wpCode + '.json'
                        , 'json', false
                    ]);

                    // Calling Web Worker to load POI POINT
                    loadWorker.postMessage([
                        'POI POINT',
                        siteConfig.siteAddress +
                        siteConfig.siteDataFolder +
                        dataSource._point.poiPoint
                        , 'csv', true
                    ]);

                    // Calling Web Worker to load BILL POINT
                    loadWorker.postMessage([
                        'BILL POINT',
                        siteConfig.siteAddress +
                        siteConfig.siteDataFolder +
                        dataSource._point.billboardPoint
                        , 'xlsx', true, 'Lat', 'Lng'
                    ]);

                    // Calling Web Worker to load CAK TRX
                    loadWorker.postMessage([
                        'CAK TRX',
                        siteConfig.siteAddress +
                        siteConfig.siteDataFolder +
                        dataSource._transaction.cakrawala
                        , 'xlsx', false
                    ]);

                    // Calling Web Worker to load JTI PRODUCT
                    loadWorker.postMessage([
                        'JTI PRODUCT',
                        siteConfig.siteAddress +
                        siteConfig.siteDataFolder +
                        dataSource._mapping.jtiProduct
                        , 'xlsx', false
                    ]);

                    // Calling Web Worker to load SOB PRODUCT
                    loadWorker.postMessage([
                        'SOB PRODUCT',
                        siteConfig.siteAddress +
                        siteConfig.siteDataFolder +
                        dataSource._mapping.sobProduct
                        , 'xlsx', false
                    ]);

                    // Web Worker Result listener
                    loadWorker.onmessage = (result) => {
                        if (result.data.source == 'IDM POINT') {
                            geoIdm = result.data.result;
                            layerIdm = initVisual(layerIdm, geoIdm, {
                                icon: siteConfig.siteResourceFolder.icon +
                                    dataSource._icon.idmIcon,
                                opacity: 1,
                                zIndex: 30,
                                visible: false,
                            });
                            layerIdm.addListener('click', (event) => {
                                onClickFunction(event.feature, 3);
                            });
                        }
                        else if (result.data.source == 'IDM TRX') {
                            transactionIdm = result.data.result;
                        }
                        else if (result.data.source == 'JTI POINT') {
                            geoJTI = result.data.result;
                            layerJTI = initVisual(layerJTI, geoJTI);
                            layerJTI.setStyle(function (feature) {
                                var channel = feature.getProperty(siteConfig.bosnetCustCategory);
                                var icn;
                                switch (channel) {
                                    case siteConfig.channel.wholesale.label:
                                        icn = siteConfig.siteResourceFolder.icon + dataSource._icon.jtiIcon.ws;
                                        break;
                                    case siteConfig.channel.retail.label:
                                        icn = siteConfig.siteResourceFolder.icon + dataSource._icon.jtiIcon.rt;
                                        break;

                                    default:
                                        break;
                                }
                                return {
                                    icon: icn,
                                    opacity: 1,
                                    zIndex: 60,
                                    visible: false,
                                }

                            });
                            layerJTI.addListener('click', (event) => {
                                onClickFunction(event.feature, 2);
                            });
                        }
                        else if (result.data.source == 'JTI TRX') {
                            transactionBosnet = result.data.result;
                        }
                        else if (result.data.source == 'JTI TRX L4W') {
                            transactionL4w = result.data.result;
                        }
                        else if (result.data.source == 'POI POINT') {
                            geoPoi = result.data.result;
                            layerPoi = initVisual(layerPoi, geoPoi, {
                                icon: siteConfig.siteResourceFolder.icon +
                                    dataSource._icon.poiIcon,
                                opacity: 1,
                                zIndex: 40,
                                visible: false,
                            });
                        }
                        else if (result.data.source == 'BILL POINT') {
                            geoBillboard = result.data.result;
                            layerBillboard = initVisual(layerBillboard, geoBillboard, {
                                icon: siteConfig.siteResourceFolder.icon +
                                    dataSource._icon.billboardIcon,
                                opacity: 1,
                                zIndex: 50,
                                visible: false,
                            });
                        }
                        else if (result.data.source == 'CAK TRX') {
                            transactionCakrawala = result.data.result;
                            transactionCakrawalaFiltered = transactionCakrawala.filter((data) => data['Work Place'].slice(0, data['Work Place'].indexOf(' ')) == wpCode);
                        }
                        // JTI PRODUCT result and initiate Category Filter
                        else if (result.data.source == 'JTI PRODUCT') {
                            jtiProduct = result.data.result;
                            jtiProduct.forEach(data => {
                                var temp = data['Segment'];
                                if (categoryFilter.length != 0 && categoryFilter.includes(temp)) {
                                    return;
                                } else {
                                    categoryFilter.push(temp);
                                }
                            });
                            initFilter(elmCategoryFilter, categoryFilter);
                        }
                        else if (result.data.source == 'SOB PRODUCT') {
                            sobProduct = result.data.result;
                            sobProductIdm = sobProduct.filter((product) => product['Source Data'] == 'IDM');
                            sobProductCakrawala = sobProduct.filter((product) => product['Source Data'] == 'Cakrawala');
                        }
                    };

                    // TODO : Find a way to identify both JTI TRX and JTI TRX L4W initiated, then combine the result to transactionAll
                }
            } catch (err) {
                console.error('Unsupported browser for background threading. ' + err.message);
            }
        }

        /**
         * initVisual is function to draw geo spatial data in Google Map Data Layer
         * @param layer : Data Layer variable to be initiated inside the function
         * @param data  : GeoJson variable to added into Data Layer
         * @param style : Data Layer styling option to be implemented
         * @response    : Google Map Data Layer
         * Notes        : @param style can be set outside this function
         **/
        function initVisual(layer, data, style) {
            layer = new google.maps.Data({ map: map });
            layer.addGeoJson(data);
            layer.setStyle(function (feature) {
                return style;
            });
            return layer;
        }

        /**
         * initFilter is function to populate filters on the top of the pages
         * @param domElement    : DOM HTML Element of <ul> for the dropdown list
         * @param dropdownArray : Array of Strings values to populate the dropdown
         * Notes                : Each of dropdown element have Click event listener that trigger onFilterClick function, passing the id of domElement and id from dropdownArray 
        **/
        function initFilter(domElement, dropdownArray) {
            domElement.innerHTML = '';
            var elmListCategoryNode;

            dropdownArray.forEach(item => {
                elmListCategoryNode = document.createElement('li');
                var elmLinkNode = document.createElement('a');

                var elmText;
                elmLinkNode.setAttribute('class', 'dropdown-item');
                elmLinkNode.setAttribute('href', '#');
                elmLinkNode.setAttribute('id', item);
                elmText = document.createTextNode(item);
                domElement.setAttribute('style', 'max-height: 400px; overflow-y: auto;')
                elmLinkNode.addEventListener("click", (event) => {
                    onFilterClick(event.target.id, domElement.id);
                });
                elmLinkNode.appendChild(elmText);
                elmListCategoryNode.appendChild(elmLinkNode);
                domElement.appendChild(elmListCategoryNode);
            });
        }

        function onFilterClick(elementId, parentId) {
            console.log(elementId);
            console.log(parentId);
        }

        /**
         * loadData is function to load data from URL and transform it into geoJson data type
         * @param callback      : callback function
         * Accepted file type   : zip (shp), json, csv, xlsx (inc. xlsb)
         * Functions used       : shp(url), loadDataToArray(url, file_type, transform to geoJson boolean, latitude column name, longitude column name, 0/1 to convert string to number)
         * Notes                : This is asyncronous function and using await to load the data.
         * **/
        async function loadData(callback) {
            try {
                // Load workplace boundary shp file
                layerWorkplaceBoundary = await shp(
                    siteConfig.siteAddress +
                    siteConfig.siteDataFolder +
                    dataSource._shp.wpBoundary
                    , 'shp', true)
                    // Initiate visual for loaded workplace boundary shp file 
                    .then(result => {
                        return initVisual(layerWorkplaceBoundary, result, {
                            fillOpacity: 0.0,
                            strokeColor: color.black,
                            strokeWeight: 1.0,
                            zIndex: 10,
                        });
                    })
                    .catch(error => console.error(error));
                // Load square boundary shp file then initiate visual and add listener
                layerSquareBoundary = await shp(
                    siteConfig.siteAddress +
                    siteConfig.siteDataFolder +
                    dataSource._shp.sqBoundary +
                    dataSource._shp.sqBoundaries.javanusa
                    , 'shp', true)
                    // Initiate visual for loaded square boundary shp file
                    .then(result => {
                        var fillOp = 0.6;
                        layerSquareBoundary = initVisual(layerSquareBoundary, result);
                        layerSquareBoundary.setStyle((feature) => {
                            var segment = feature.getProperty(siteConfig.squareSegmentProperty);
                            var color;
                            switch (segment) {
                                case siteConfig.segment.win.label:
                                    color = siteConfig.segment.win.color;
                                    break;
                                case siteConfig.segment.tactical.label:
                                    color = siteConfig.segment.tactical.color;
                                    break;
                                case siteConfig.segment.sustain.label:
                                    color = siteConfig.segment.sustain.color;
                                    break;
                                case siteConfig.segment.non_investable.label:
                                    color = siteConfig.segment.non_investable.color;
                                    break;
                                case siteConfig.segment.expand.label:
                                    color = siteConfig.segment.expand.color;
                                    break;
                                default:
                                    color = color.gray;
                                    fillOp = 0.2;
                                    break;
                            }
                            return {
                                fillColor: color,
                                fillOpacity: fillOp,
                                strokeWeight: 0.1,
                                zIndex: 20,
                            };
                        });
                        layerSquareBoundary.addListener('click', (event) => {
                            onClickFunction(event.feature, 1);
                        });
                        // Get unique values of Square Segment and stored in squareSegmentationFilter
                        layerSquareBoundary.forEach(feature => {
                            var temp = feature.getProperty(siteConfig.squareSegmentProperty);
                            if (squareSegmentationFilter.length != 0 && squareSegmentationFilter.includes(temp)) {
                                return;
                            } else {
                                squareSegmentationFilter.push(temp);
                            }
                        });
                        // Get unique values of Square Id and stored in squareIdFilter
                        layerSquareBoundary.forEach(feature => {
                            var temp = feature.getProperty(siteConfig.squareIdProperty);
                            if (squareIdFilter.length != 0 && squareIdFilter.includes(temp)) {
                                return;
                            } else {
                                squareIdFilter.push(temp);
                            }
                        });
                        // Get unique values of Square Category and stored in squareCategoryFilter
                        layerSquareBoundary.forEach(feature => {
                            var temp = feature.getProperty(siteConfig.squareCategoryProperty);
                            if (squareCategoryFilter.length != 0 && squareCategoryFilter.includes(temp)) {
                                return;
                            } else {
                                squareCategoryFilter.push(temp);
                            }
                        });
                        // Call initFilter to populate dropdown filter on top page
                        initFilter(elmSquareCategoryFilter, squareCategoryFilter);
                        initFilter(elmSquareSegmentFilter, squareSegmentationFilter);
                        initFilter(elmSquareIdFilter, squareIdFilter);

                        return layerSquareBoundary;
                    })
                    .catch(error => console.error(error));
                // Calling callback function
                callback();
            } catch (err) {
                console.error('Data failed to load: ' + err.message);
            }
        }

        /** !!!!! UNUSED !!!!!
         * initMapVisual is function to populate visual to Google layer based on geoJson data
         * @param callback      : callback function
         * Layers created in this function have styling and addListener for click
        **/
        async function initMapVisual(callback) {
            try {
                // // Create layer for Workplace Boundary
                // layerWorkplaceBoundary = new google.maps.Data({ map: map });
                // // Adding geoJson geoWorkplace to layerWorkplaceBoundary
                // layerWorkplaceBoundary.addGeoJson(geoWorkplace);
                // // Adding style to layerWorkplaceBoundary
                // layerWorkplaceBoundary.setStyle(function (feature) {
                //     return {
                //         fillOpacity: 0.0,
                //         strokeColor: color.black,
                //         strokeWeight: 1.0,
                //         zIndex: 10,
                //     };
                // });

                // // Create layer for Square Boundary
                // layerSquareBoundary = new google.maps.Data({ map: map });
                // // Adding geoJson geoSquare to layerSquareBoundary
                // layerSquareBoundary.addGeoJson(geoSquare);
                // // Adding style to layerSquareBoundary
                // // Styling based on square segmentation (WIN, TACTICAL, SUSTAIN, EXPAND, and NON-INVESTABLE)
                // layerSquareBoundary.setStyle(function (feature) {
                //     var segment = feature.getProperty(siteConfig.squareSegmentProperty);
                //     var color;
                //     var fillOp = 0.6;
                //     switch (segment) {
                //         case siteConfig.segment.win.label:
                //             color = siteConfig.segment.win.color;
                //             break;
                //         case siteConfig.segment.tactical.label:
                //             color = siteConfig.segment.tactical.color;
                //             break;
                //         case siteConfig.segment.sustain.label:
                //             color = siteConfig.segment.sustain.color;
                //             break;
                //         case siteConfig.segment.non_investable.label:
                //             color = siteConfig.segment.non_investable.color;
                //             break;
                //         case siteConfig.segment.expand.label:
                //             color = siteConfig.segment.expand.color;
                //             break;
                //         default:
                //             color = color.gray;
                //             fillOp = 0.2;
                //             break;
                //     }
                //     return {
                //         fillColor: color,
                //         fillOpacity: fillOp,
                //         strokeWeight: 0.1,
                //         zIndex: 20,
                //     };
                // });
                // Adding listener click event to layerSquareBoundary, passing layer feature (specific square) as parameter
                // This listener is trigger onClickFunction to show InfoWindows (pop-up)
                // layerSquareBoundary.addListener('click', (event) => {
                //     onClickFunction(event.feature, 1);
                // });

                // // Create layer for Indomaret Points (store location)
                // layerIdm = new google.maps.Data({ map: map });
                // // Adding geoJson geoIdm to layerIdm
                // layerIdm.addGeoJson(geoIdm);
                // // Setting style for layerIdm
                // layerIdm.setStyle({
                //     icon: siteConfig.siteResourceFolder.icon +
                //         dataSource._icon.idmIcon,
                //     opacity: 1,
                //     zIndex: 30,
                //     visible: false,
                // });
                // Adding listener click event to layerIdm, passing layer feature (specific point) as parameter
                // This listener is trigger onClickFunction to show InfoWindows (pop-up)
                // layerIdm.addListener('click', (event) => {
                //     onClickFunction(event.feature, 3);
                // });

                // // Create layer for Point Of Interest Points (POI location)
                // layerPoi = new google.maps.Data({ map: map });
                // // Adding geoJson geoPoi to layerPoi
                // layerPoi.addGeoJson(geoPoi);
                // // Setting style for layerPoi
                // layerPoi.setStyle({
                //     icon: siteConfig.siteResourceFolder.icon +
                //         dataSource._icon.poiIcon,
                //     opacity: 1,
                //     zIndex: 40,
                //     visible: false,
                // });

                // layerBillboard = new google.maps.Data({ map: map });
                // layerBillboard.addGeoJson(geoBillboard);
                // layerBillboard.setStyle({
                //     icon: siteConfig.siteResourceFolder.icon +
                //         dataSource._icon.billboardIcon,
                //     opacity: 1,
                //     zIndex: 50,
                //     visible: false,
                // });

                // layerJTI = new google.maps.Data({ map: map });
                // layerJTI.addGeoJson(geoJTI);
                // layerJTI.setStyle(function (feature) {
                //     var channel = feature.getProperty(siteConfig.bosnetCustCategory);
                //     var icn;
                //     switch (channel) {
                //         case siteConfig.channel.wholesale.label:
                //             icn = siteConfig.siteResourceFolder.icon + dataSource._icon.jtiIcon.ws;
                //             break;
                //         case siteConfig.channel.retail.label:
                //             icn = siteConfig.siteResourceFolder.icon + dataSource._icon.jtiIcon.rt;
                //             break;

                //         default:
                //             break;
                //     }
                //     return {
                //         icon: icn,
                //         opacity: 1,
                //         zIndex: 60,
                //         visible: false,
                //     }

                // });
                // layerJTI.addListener('click', (event) => {
                //     onClickFunction(event.feature, 2);
                // });

                callback();
            }
            catch (err) {
                console.error('Map visual failed to load: ' + err.message);
            }
        }

        /** !!!!! UNUSED !!!!!
         *  **/
        function ainitFilter() {
            try {
                // elmCategoryFilter.innerHTML = '';

                // jtiProduct.forEach(data => {
                //     var temp = data['Segment'];
                //     if (categoryFilter.length != 0 && categoryFilter.includes(temp)) {
                //         return;
                //     } else {
                //         categoryFilter.push(temp);
                //     }
                // });
                // var elmListCategoryNode;

                // categoryFilter.forEach(item => {
                //     elmListCategoryNode = document.createElement('li');
                //     var elmLinkNode = document.createElement('a');

                //     var elmText;
                //     elmLinkNode.setAttribute('class', 'dropdown-item');
                //     elmLinkNode.setAttribute('href', '#');
                //     elmLinkNode.setAttribute('id', item);
                //     elmText = document.createTextNode(item);
                //     elmLinkNode.addEventListener("click", (event) => {
                //         filterCategory(event.target.id);
                //     });
                //     elmLinkNode.appendChild(elmText);
                //     elmListCategoryNode.appendChild(elmLinkNode);
                //     elmCategoryFilter.appendChild(elmListCategoryNode);
                // });

                // Square segment filter
                // Get array of segmentation from layerSquareBoundary
                // elmSquareSegmentFilter.innerHTML = ''; // clear out html element
                // layerSquareBoundary.forEach(feature => {
                //     var temp = feature.getProperty(siteConfig.squareSegmentProperty);
                //     if (squareSegmentationFilter.length != 0 && squareSegmentationFilter.includes(temp)) {
                //         return;
                //     } else {
                //         squareSegmentationFilter.push(temp);
                //     }
                // });
                // // sort squareSegmentationFilter in alphabetical order
                // squareSegmentationFilter.sort();
                // // create elements for each item in array
                // var elmListSqSegNode;
                // squareSegmentationFilter.forEach(item => {
                //     elmListSqSegNode = document.createElement('li');
                //     var elmLinkNode = document.createElement('a');

                //     var elmText;
                //     elmLinkNode.setAttribute('class', 'dropdown-item'); // set attribute for a
                //     elmLinkNode.setAttribute('href', '#'); // set attribute for a
                //     elmLinkNode.setAttribute('id', item);
                //     elmText = document.createTextNode(item);
                //     elmLinkNode.addEventListener("click", (event) => {
                //         layerSquareBoundary.revertStyle();
                //         overrideSegmentStyle(event.target.id, 0);
                //     });
                //     elmLinkNode.appendChild(elmText);
                //     elmListSqSegNode.appendChild(elmLinkNode);
                //     elmSquareSegmentFilter.appendChild(elmListSqSegNode);
                // });
                // empty the element and add prepared node

                // Square ID filter
                // elmSquareIdFilter.innerHTML = '';
                // elmSquareIdFilter.setAttribute('style', 'max-height: 400px; overflow-y: auto;')
                // layerSquareBoundary.forEach(feature => {
                //     var temp = feature.getProperty(siteConfig.squareIdProperty);
                //     if (squareIdFilter.length != 0 && squareIdFilter.includes(temp)) {
                //         return;
                //     } else {
                //         squareIdFilter.push(temp);
                //     }
                // });
                // squareIdFilter.sort();

                // var elmListSqIdNode;
                // squareIdFilter.forEach(item => {
                //     elmListSqIdNode = document.createElement('li');
                //     var elmLinkNode = document.createElement('a');
                //     var elmText;
                //     elmLinkNode.setAttribute('class', 'dropdown-item'); // set attribute for a
                //     elmLinkNode.setAttribute('href', '#'); // set attribute for a
                //     elmLinkNode.setAttribute('id', item);
                //     elmText = document.createTextNode(item);
                //     elmLinkNode.appendChild(elmText);
                //     elmListSqIdNode.appendChild(elmLinkNode);
                //     elmSquareIdFilter.appendChild(elmListSqIdNode);
                //     elmLinkNode.addEventListener("click", (event) => {
                //         layerSquareBoundary.revertStyle();
                //         overrideSegmentStyle(event.target.id, 1);
                //     });
                // });


                // elmSquareCategoryFilter.innerHTML = ''; // clear out html element
                // layerSquareBoundary.forEach(feature => {
                //     var temp = feature.getProperty(siteConfig.squareCategoryProperty);
                //     if (squareCategoryFilter.length != 0 && squareCategoryFilter.includes(temp)) {
                //         return;
                //     } else {
                //         squareCategoryFilter.push(temp);
                //     }
                // });
                // // sort squareSegmentationFilter in alphabetical order
                // squareCategoryFilter.sort();
                // // create elements for each item in array
                // var elmListSqCatNode;
                // squareCategoryFilter.forEach(item => {
                //     elmListSqCatNode = document.createElement('li');
                //     var elmLinkNode = document.createElement('a');

                //     var elmText;
                //     elmLinkNode.setAttribute('class', 'dropdown-item'); // set attribute for a
                //     elmLinkNode.setAttribute('href', '#'); // set attribute for a
                //     elmLinkNode.setAttribute('id', item);
                //     elmText = document.createTextNode(item);
                //     elmLinkNode.addEventListener("click", (event) => {
                //         layerSquareBoundary.revertStyle();
                //         overrideSegmentStyle(event.target.id, 2);
                //     });
                //     elmLinkNode.appendChild(elmText);
                //     elmListSqCatNode.appendChild(elmLinkNode);
                //     elmSquareCategoryFilter.appendChild(elmListSqCatNode);
                // });
            }
            catch (err) {
                console.error('Initialize Filter Failed. ' + err.message);
            }


        }

        function initCustomControl() {
            const eyeIcon = siteConfig.siteResourceFolder.icon + '/ic_fluent_eye_show_24_filled.ico';
            const eyeIconClosed = siteConfig.siteResourceFolder.icon + '/ic_fluent_eye_hide_24_filled.ico';

            const rightTopControlDiv = document.createElement("div");

            const controlButton = document.createElement("button");

            controlButton.style.backgroundColor = "#fff";
            controlButton.style.border = "2px solid #fff";
            controlButton.style.borderRadius = "3px";
            controlButton.style.boxShadow = "0 2px 6px rgba(0,0,0,.3)";
            controlButton.style.color = "rgb(25,25,25)";
            controlButton.style.cursor = "pointer";
            controlButton.style.fontFamily = "Roboto,Arial,sans-serif";
            controlButton.style.fontSize = "16px";
            controlButton.style.lineHeight = "38px";
            controlButton.style.margin = "8px 8px 8px 8px";
            controlButton.style.padding = "0 5px";
            controlButton.style.textAlign = "center";

            controlButton.setAttribute('class', 'dropdown-toggle');
            controlButton.setAttribute('data-bs-toggle', 'dropdown');
            controlButton.setAttribute('data-bs-auto-close', 'true');
            controlButton.setAttribute('aria-expanded', 'false');
            controlButton.id = 'mapDropdown';

            controlButton.innerHTML = '<img src="' + siteConfig.siteResourceFolder.icon + '/ic_fluent_layer_24_regular.ico"></i>';
            controlButton.title = "Click to open filters";
            controlButton.type = "button";

            const ulElm = document.createElement('ul');
            ulElm.setAttribute('class', 'dropdown-menu');
            ulElm.setAttribute('aria-labelledby', 'mapDropdown');

            const elmLiSquare = document.createElement('li');
            elmLiSquare.id = 'square';
            const elmASquare = document.createElement('a');
            elmASquare.setAttribute('class', 'dropdown-item');
            var iconSq = layerSquareBoundaryStatus ? eyeIcon : eyeIconClosed;
            elmASquare.innerHTML = '<img src="' + iconSq + '"></i> Square';
            elmASquare.addEventListener("click", (event) => {
                layerSquareBoundaryStatus = filterVisual(layerSquareBoundary, layerSquareBoundaryStatus);
                iconSq = layerSquareBoundaryStatus ? eyeIcon : eyeIconClosed;
                elmASquare.innerHTML = '<img src="' + iconSq + '"></i> Square';
            });
            elmLiSquare.appendChild(elmASquare);
            ulElm.appendChild(elmLiSquare);

            const elmLiJTI = document.createElement('li');
            elmLiJTI.id = 'jti';
            const elmAJTI = document.createElement('a');
            elmAJTI.setAttribute('class', 'dropdown-item');
            var iconJTI = layerWorkplaceBoundaryStatus ? eyeIcon : eyeIconClosed;
            elmAJTI.innerHTML = '<img src="' + iconJTI + '"></i> JTI Coverage';
            elmAJTI.addEventListener("click", (event) => {
                layerWorkplaceBoundaryStatus = filterVisual(layerWorkplaceBoundary, layerWorkplaceBoundaryStatus);
                iconJTI = layerWorkplaceBoundaryStatus ? eyeIcon : eyeIconClosed;
                elmAJTI.innerHTML = '<img src="' + iconJTI + '"></i> JTI Coverage';
            });
            elmLiJTI.appendChild(elmAJTI);
            ulElm.appendChild(elmLiJTI);

            const elmLiJTIStore = document.createElement('li');
            elmLiJTIStore.id = 'jtiStore';
            elmAJTIStore = document.createElement('a');
            elmAJTIStore.setAttribute('class', 'dropdown-item disabled');
            elmAJTIStore.setAttribute('aria-disabled', 'true');
            var iconJTIStore = layerJTIStatus ? eyeIcon : eyeIconClosed;
            elmAJTIStore.innerHTML = '<img src="' + iconJTIStore + '"></i> JTI Store';
            elmAJTIStore.addEventListener("click", (event) => {
                layerJTIStatus = filterVisual(layerJTI, layerJTIStatus);
                iconJTIStore = layerJTIStatus ? eyeIcon : eyeIconClosed;
                elmAJTIStore.innerHTML = '<img src="' + iconJTIStore + '"></i> JTI Store';
            });
            elmLiJTIStore.appendChild(elmAJTIStore);
            ulElm.appendChild(elmLiJTIStore);

            const elmLiIDMStore = document.createElement('li');
            elmLiIDMStore.id = 'idmStore';
            elmAIDMStore = document.createElement('a');
            elmAIDMStore.setAttribute('class', 'dropdown-item disabled');
            elmAIDMStore.setAttribute('aria-disabled', 'true');
            var iconIDMStore = layerIdmStatus ? eyeIcon : eyeIconClosed;
            elmAIDMStore.innerHTML = '<img src="' + iconIDMStore + '"></i> IDM Store';
            elmAIDMStore.addEventListener("click", (event) => {
                layerIdmStatus = filterVisual(layerIdm, layerIdmStatus);
                iconIDMStore = layerIdmStatus ? eyeIcon : eyeIconClosed;
                elmAIDMStore.innerHTML = '<img src="' + iconIDMStore + '"></i> IDM Store';
            });
            elmLiIDMStore.appendChild(elmAIDMStore);
            ulElm.appendChild(elmLiIDMStore);

            const elmLiPoi = document.createElement('li');
            elmLiPoi.id = 'poi';
            elmAPoi = document.createElement('a');
            elmAPoi.setAttribute('class', 'dropdown-item disabled');
            elmAPoi.setAttribute('aria-disabled', 'true');
            var iconPOI = layerPoiStatus ? eyeIcon : eyeIconClosed;
            elmAPoi.innerHTML = '<img src="' + iconPOI + '"></i> POI';
            elmAPoi.addEventListener("click", (event) => {
                layerPoiStatus = filterVisual(layerPoi, layerPoiStatus);
                iconPOI = layerPoiStatus ? eyeIcon : eyeIconClosed;
                elmAPoi.innerHTML = '<img src="' + iconPOI + '"></i> POI';
            });
            elmLiPoi.appendChild(elmAPoi);
            ulElm.appendChild(elmLiPoi);

            const elmLiBill = document.createElement('li');
            elmLiBill.id = 'billboard';
            elmABill = document.createElement('a');
            elmABill.setAttribute('class', 'dropdown-item disabled');
            elmABill.setAttribute('aria-disabled', 'true');
            var iconBillboard = layerBillboardStatus ? eyeIcon : eyeIconClosed;
            elmABill.innerHTML = '<img src="' + iconBillboard + '"></i> Billboard';
            elmABill.addEventListener("click", (event) => {
                layerBillboardStatus = filterVisual(layerBillboard, layerBillboardStatus);
                iconBillboard = layerBillboardStatus ? eyeIcon : eyeIconClosed;
                elmABill.innerHTML = '<img src="' + iconBillboard + '"></i> Billboard';
            });
            elmLiBill.appendChild(elmABill);
            ulElm.appendChild(elmLiBill);

            rightTopControlDiv.appendChild(controlButton);
            rightTopControlDiv.appendChild(ulElm);

            return rightTopControlDiv;
        }

        function overrideSegmentStyle(elmId, type) {
            // memfilter square based on segement id EXPAND, TACTICAL, WIN, SUSTAIN, NON-INVESTABLE
            layerSquareBoundary.forEach(feature => {
                switch (type) {
                    case 0:
                        var segment = feature.getProperty(siteConfig.squareSegmentProperty);
                        if (segment != elmId) {
                            layerSquareBoundary.overrideStyle(feature, {
                                strokeColor: 'yellow',
                                strokeWeight: 0.0,
                                fillOpacity: 0.0,
                            });
                        }
                        break;
                    case 1:
                        var segment = feature.getProperty(siteConfig.squareIdProperty);
                        if (segment == elmId) {
                            layerSquareBoundary.overrideStyle(feature, {
                                strokeColor: 'yellow',
                                strokeWeight: 0.0,
                                fillOpacity: 0.0,
                            });
                        }
                        break;
                    case 2:
                        var segment = feature.getProperty(siteConfig.squareCategoryProperty);
                        if (segment == elmId) {
                            layerSquareBoundary.overrideStyle(feature, {
                                strokeColor: 'yellow',
                                strokeWeight: 0.0,
                                fillOpacity: 0.0,
                            });
                        }
                        break;
                    default:
                        break;
                }

            });

        }

        function filterCategory(elm) {
            if (infowindow.isOpen) {

                var trElements = document.getElementById('infoWindow').children;

                for (let index = 0; index < trElements.length; index++) {
                    if (trElements[index].getAttribute('id') !== null) {
                        if (trElements[index].getAttribute('id') == elm) {
                            trElements[index].classList.remove('d-none');
                        }
                        else {
                            trElements[index].classList.add('d-none');
                        }

                    }

                    if (trElements[index].getAttribute('data-category') !== null) {
                        if (trElements[index].getAttribute('data-category') == elm) {
                            trElements[index].classList.remove('d-none');
                        }
                        else {
                            trElements[index].classList.add('d-none');
                        }
                    }

                }

            }
            if (wpCode !== undefined) {
                updateVolumeChart(elm);
                updateDropSizeChart(elm);
            }

        }

        function updateVolumeChart(elm) {
            var dataset = new Array();
            // TODO: CHECK IF WORKPLACE IS SELECTED.
            var tempSquareFeatures = new Array();
            layerSquareBoundary.forEach(feature => {
                if (feature.getProperty('Id_Workpla') == wpCode) {
                    tempSquareFeatures.push(feature);
                }
            });

            var allTrx = transactionL4w.concat(transactionBosnet);

            var allVolume = calculateVolume5Week(tempSquareFeatures, allTrx);

            var filteredVolume = allVolume.filter(data => data['category'] == elm);

            var total = [0, 0, 0, 0, 0];
            for (let index = 0; index < 5; index++) {
                filteredVolume.forEach(data => {
                    if (data['WeekNumber'] == index + 1) {
                        total[index] = total[index] + data['volume'];
                    }
                });
            }

            volumeChart.data =
            {
                labels: ['WK1', 'WK2', 'WK3', 'WK4', 'WK5'],
                datasets: [{
                    type: 'bar',
                    label: siteConfig.segment.win.label,
                    backgroundColor: siteConfig.segment.win.color,
                    data: [
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.win.label && data['WeekNumber'] == 1)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.win.label && data['WeekNumber'] == 2)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.win.label && data['WeekNumber'] == 3)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.win.label && data['WeekNumber'] == 4)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.win.label && data['WeekNumber'] == 5)[0]['volume'],
                    ],
                    borderWidth: 1,
                    order: 2,
                }, {
                    type: 'bar',
                    label: siteConfig.segment.expand.label,
                    backgroundColor: siteConfig.segment.expand.color,
                    data: [
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.expand.label && data['WeekNumber'] == 1)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.expand.label && data['WeekNumber'] == 2)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.expand.label && data['WeekNumber'] == 3)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.expand.label && data['WeekNumber'] == 4)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.expand.label && data['WeekNumber'] == 5)[0]['volume'],
                    ],
                    borderWidth: 1,
                    order: 2,
                }, {
                    type: 'bar',
                    label: siteConfig.segment.sustain.label,
                    backgroundColor: siteConfig.segment.sustain.color,
                    data: [
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.sustain.label && data['WeekNumber'] == 1)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.sustain.label && data['WeekNumber'] == 2)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.sustain.label && data['WeekNumber'] == 3)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.sustain.label && data['WeekNumber'] == 4)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.sustain.label && data['WeekNumber'] == 5)[0]['volume'],
                    ],
                    borderWidth: 1,
                    order: 2,
                }, {
                    type: 'bar',
                    label: siteConfig.segment.tactical.label,
                    backgroundColor: siteConfig.segment.tactical.color,
                    data: [
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.tactical.label && data['WeekNumber'] == 1)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.tactical.label && data['WeekNumber'] == 2)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.tactical.label && data['WeekNumber'] == 3)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.tactical.label && data['WeekNumber'] == 4)[0]['volume'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.tactical.label && data['WeekNumber'] == 5)[0]['volume'],
                    ],
                    borderWidth: 1,
                    order: 2,
                }, {
                    type: 'bar',
                    label: siteConfig.segment.non_investable.label,
                    backgroundColor: siteConfig.segment.non_investable.color,
                    data: [
                        allVolume.filter(data => data['squareSegment'] == siteConfig.segment.non_investable.label && data['WeekNumber'] == 1)[0]['volume'],
                        allVolume.filter(data => data['squareSegment'] == siteConfig.segment.non_investable.label && data['WeekNumber'] == 2)[0]['volume'],
                        allVolume.filter(data => data['squareSegment'] == siteConfig.segment.non_investable.label && data['WeekNumber'] == 3)[0]['volume'],
                        allVolume.filter(data => data['squareSegment'] == siteConfig.segment.non_investable.label && data['WeekNumber'] == 4)[0]['volume'],
                        allVolume.filter(data => data['squareSegment'] == siteConfig.segment.non_investable.label && data['WeekNumber'] == 5)[0]['volume'],
                    ],
                    borderWidth: 1,
                    order: 2,
                }, {
                    type: 'line',
                    label: 'TOTAL',
                    backgroundColor: color.gray,
                    data: total,
                    borderWidth: 1,
                    order: 1,
                }]
            }

            volumeChart.update();


        }

        function updateDropSizeChart(elm) {
            var dataset = new Array();
            // TODO: CHECK IF WORKPLACE IS SELECTED.
            var tempSquareFeatures = new Array();
            layerSquareBoundary.forEach(feature => {
                if (feature.getProperty('Id_Workpla') == wpCode) {
                    tempSquareFeatures.push(feature);
                }
            });

            var allTrx = transactionL4w.concat(transactionBosnet);

            var allVolume = calculateDropSize5Week(tempSquareFeatures, allTrx);

            var filteredVolume = allVolume.filter(data => data['category'] == elm);

            var total = [0, 0, 0, 0, 0];
            for (let index = 0; index < 5; index++) {
                filteredVolume.forEach(data => {
                    if (data['WeekNumber'] == index + 1) {
                        total[index] = total[index] + data['ds'];
                    }
                });
            }


            dropSizeChart.data =
            {
                labels: ['WK1', 'WK2', 'WK3', 'WK4', 'WK5'],
                datasets: [{
                    type: 'bar',
                    label: siteConfig.segment.win.label,
                    backgroundColor: siteConfig.segment.win.color,
                    data: [
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.win.label && data['WeekNumber'] == 1)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.win.label && data['WeekNumber'] == 2)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.win.label && data['WeekNumber'] == 3)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.win.label && data['WeekNumber'] == 4)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.win.label && data['WeekNumber'] == 5)[0]['ds'],
                    ],
                    borderWidth: 1,
                    order: 2,
                }, {
                    type: 'bar',
                    label: siteConfig.segment.expand.label,
                    backgroundColor: siteConfig.segment.expand.color,
                    data: [
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.expand.label && data['WeekNumber'] == 1)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.expand.label && data['WeekNumber'] == 2)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.expand.label && data['WeekNumber'] == 3)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.expand.label && data['WeekNumber'] == 4)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.expand.label && data['WeekNumber'] == 5)[0]['ds'],
                    ],
                    borderWidth: 1,
                    order: 2,
                }, {
                    type: 'bar',
                    label: siteConfig.segment.sustain.label,
                    backgroundColor: siteConfig.segment.sustain.color,
                    data: [
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.sustain.label && data['WeekNumber'] == 1)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.sustain.label && data['WeekNumber'] == 2)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.sustain.label && data['WeekNumber'] == 3)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.sustain.label && data['WeekNumber'] == 4)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.sustain.label && data['WeekNumber'] == 5)[0]['ds'],
                    ],
                    borderWidth: 1,
                    order: 2,
                }, {
                    type: 'bar',
                    label: siteConfig.segment.tactical.label,
                    backgroundColor: siteConfig.segment.tactical.color,
                    data: [
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.tactical.label && data['WeekNumber'] == 1)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.tactical.label && data['WeekNumber'] == 2)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.tactical.label && data['WeekNumber'] == 3)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.tactical.label && data['WeekNumber'] == 4)[0]['ds'],
                        filteredVolume.filter(data => data['squareSegment'] == siteConfig.segment.tactical.label && data['WeekNumber'] == 5)[0]['ds'],
                    ],
                    borderWidth: 1,
                    order: 2,
                }, {
                    type: 'bar',
                    label: siteConfig.segment.non_investable.label,
                    backgroundColor: siteConfig.segment.non_investable.color,
                    data: [
                        allVolume.filter(data => data['squareSegment'] == siteConfig.segment.non_investable.label && data['WeekNumber'] == 1)[0]['ds'],
                        allVolume.filter(data => data['squareSegment'] == siteConfig.segment.non_investable.label && data['WeekNumber'] == 2)[0]['ds'],
                        allVolume.filter(data => data['squareSegment'] == siteConfig.segment.non_investable.label && data['WeekNumber'] == 3)[0]['ds'],
                        allVolume.filter(data => data['squareSegment'] == siteConfig.segment.non_investable.label && data['WeekNumber'] == 4)[0]['ds'],
                        allVolume.filter(data => data['squareSegment'] == siteConfig.segment.non_investable.label && data['WeekNumber'] == 5)[0]['ds'],
                    ],
                    borderWidth: 1,
                    order: 2,
                }, {
                    type: 'line',
                    label: 'TOTAL',
                    backgroundColor: color.gray,
                    data: total,
                    borderWidth: 1,
                    order: 1,
                }]
            }

            dropSizeChart.update();


        }

        function onClickFunction(feature, type) {
            let table = document.createElement('table');
            table.setAttribute('class', 'table table-sm table-striped');
            let header = document.createElement('thead');
            let body = document.createElement('tbody');
            let caption = document.createElement('caption');
            let button = document.createElement('button');
            button.type = 'button';
            button.setAttribute('class', 'btn btn-secondary btn-sm float-end');
            button.innerHTML = 'Close';
            button.addEventListener('click', (event) => {
                infowindow.close();
            });
            caption.appendChild(button);
            table.appendChild(caption);
            body.setAttribute('class', 'table-group-divider')
            body.setAttribute('style', 'height: 300px; overflow-y: auto;');
            body.id = 'infoWindow';
            let tableRow = document.createElement('tr');
            let tableHead = document.createElement('th');


            if (type == 1 && feature.getGeometry().getType() == 'Polygon') {
                var sw = feature.getGeometry().getAt(0).getAt(0);
                var ne = feature.getGeometry().getAt(0).getAt(2);
                var bound = new google.maps.LatLngBounds(sw, ne);

                function midPoint(sw, ne) {
                    var latAverage = (sw.lat() + ne.lat()) / 2;
                    var lngAverage = (sw.lng() + ne.lng()) / 2;
                    return new google.maps.LatLng(latAverage, lngAverage);
                }
                var mid = midPoint(sw, ne);

                var volume = calculateVolume(bound);
                var dropSize = calculateDropSize(bound);
                var gtStore = calculateGTstore(bound);
                var idmStore = calculateIDMStore(bound);
                var cakrawalaData = calculateCakData(bound);

                tableHead.setAttribute('colspan','2');
                tableHead.innerText = "Square ID : " + feature.getProperty(siteConfig.squareIdProperty);
                tableRow.appendChild(tableHead);
                header.appendChild(tableRow);

                volume.forEach(dt => {
                    var tableRowSquare = document.createElement('tr');
                    var label = document.createElement('td');
                    var value = document.createElement('td');
                    tableRowSquare.id = dt['category'];
                    label.innerText = 'Volume Shipment';
                    value.innerText = dt['volume'];
                    if (tableRowSquare.getAttribute('id') !== 'ALL') {
                        tableRowSquare.classList.add('d-none');
                    }
                    tableRowSquare.appendChild(label);
                    tableRowSquare.appendChild(value);
                    body.appendChild(tableRowSquare);
                });

                dropSize.forEach(dt => {
                    var tableRowSquare = document.createElement('tr');
                    var label = document.createElement('td');
                    var value = document.createElement('td');
                    tableRowSquare.id = dt['category'];
                    label.innerText = 'Dropsize';
                    value.innerText = dt['ds'].toLocaleString(numberFormat.region,
                        {
                            maximumFractionDigits: numberFormat.maxDecimalDigit,
                            minimumFractionDigits: numberFormat.minDecimalDigit,
                        },);
                    if (tableRowSquare.getAttribute('id') !== 'ALL') {
                        tableRowSquare.classList.add('d-none');
                    }
                    tableRowSquare.appendChild(label);
                    tableRowSquare.appendChild(value);
                    body.appendChild(tableRowSquare);
                });

                for (let index = 0; index < 2; index++) {
                    var tableRowSquare = document.createElement('tr');
                    var label = document.createElement('td');
                    var value = document.createElement('td');
                    switch (index) {
                        case 0:
                            label.innerText = '# of GT Stores'
                            value.innerText = gtStore;
                            break;
                        case 1:
                            label.innerText = '# of IDM Stores'
                            value.innerText = idmStore;
                            break;
                        default:
                            break;
                    }

                    tableRowSquare.appendChild(label);
                    tableRowSquare.appendChild(value);
                    body.appendChild(tableRowSquare);
                }

                // Add table separator for Cakrawala Data
                var trSeparatorCakrawala = document.createElement('tr');
                trSeparatorCakrawala.setAttribute('style', 'border-color: black');
                var tdSeparatorCakrawala = document.createElement('th');
                tdSeparatorCakrawala.setAttribute('colspan','2');
                tdSeparatorCakrawala.innerHTML = 'Cakrawala Survey';
                trSeparatorCakrawala.appendChild(tdSeparatorCakrawala);
                body.appendChild(trSeparatorCakrawala);

                sobProductCakrawala.forEach(product => {
                    let tableRowProduct = document.createElement('tr');
                    tableRowProduct.setAttribute('data-category', product['Segment']);
                    var label = product['SOB - Variant Level'];
                    var filteredSelection = cakrawalaData.filter((dt) => dt['product'] == label);

                    var elmLabel = document.createElement('td');
                    elmLabel.innerHTML = label;
                    tableRowProduct.appendChild(elmLabel);
                    var elmValue = document.createElement('td');
                    var value = filteredSelection[0]['total'] ? (filteredSelection[0]['total']).toLocaleString(numberFormat.region,
                        {
                            maximumFractionDigits: numberFormat.maxDecimalDigit,
                            minimumFractionDigits: numberFormat.minDecimalDigit,
                        },) : '0.0';
                    elmValue.innerHTML = value + ' packs';
                    tableRowProduct.appendChild(elmValue);
                    body.appendChild(tableRowProduct);
                });

                // Add table separator for IDM Performance Data
                var trSeparatorIDMPerf = document.createElement('tr');
                trSeparatorIDMPerf.setAttribute('style', 'border-color: black');
                var tdSeparatorIdmPerf = document.createElement('th');
                tdSeparatorIdmPerf.setAttribute('colspan','2');
                tdSeparatorIdmPerf.innerHTML = 'IDM Performance';
                trSeparatorIDMPerf.appendChild(tdSeparatorIdmPerf);
                body.appendChild(trSeparatorIDMPerf);

                table.appendChild(header);
                table.appendChild(body);

                infowindow.setContent(table);
                infowindow.setPosition(mid);
                infowindow.open(map);
            }
            else if (type == 2 && feature.getGeometry().getType() == 'Point') {

                tableHead.innerText = "Store Category : " + feature.getProperty(siteConfig.bosnetCustCategory);
                tableHead.setAttribute('colspan','2');
                tableRow.appendChild(tableHead);
                header.appendChild(tableRow);

                var listProduct = new Array();
                var custId = feature.getProperty('szCustId');
                var filteredTransaction = transactionBosnet.filter((line) => line['CustomerId'] == custId);
                var storeId = document.createElement('tr');
                storeId.id = custId;
                var storeIdLabel = document.createElement('td');
                storeIdLabel.innerHTML = 'Store ID';
                var storeIdValue = document.createElement('td');
                storeIdValue.innerHTML = custId;
                storeId.appendChild(storeIdLabel);
                storeId.appendChild(storeIdValue);
                body.appendChild(storeId);
                jtiProduct.forEach(product => {
                    let tableRowProduct = document.createElement('tr');
                    tableRowProduct.setAttribute('data-category', product['Segment']);
                    var tempProduct = product['KATEGORI PRODUK'];
                    var label = product['SKU Name (For pop-up details)'];
                    if (!listProduct.includes(label)) {
                        listProduct.push(label);
                        var filteredSelection = filteredTransaction.filter((transaction) => transaction['CategoryProduct'] == tempProduct);
                        var ec = 0;
                        var vol = 0;
                        filteredSelection.forEach(trx => {
                            ec += trx['EffectiveCall'];
                            vol += trx['Volume'];
                        });
                        var dropSize = (vol != 0 && ec != 0) ? vol / ec : 0;
                        var elmLabel = document.createElement('td');
                        elmLabel.innerHTML = label + ' Dz';
                        tableRowProduct.appendChild(elmLabel);
                        var elmValue = document.createElement('td');
                        elmValue.innerHTML = dropSize.toLocaleString(numberFormat, {
                            minimumFractionDigits: numberFormat.minDecimalDigit,
                            maximumFractionDigits: numberFormat.maxDecimalDigit,
                        },);
                        tableRowProduct.appendChild(elmValue);
                        body.appendChild(tableRowProduct);
                    } else {
                        // TODO add calculation if already included in array
                    }

                });

                var trSeparatorCakrawala = document.createElement('tr');
                trSeparatorCakrawala.setAttribute('style', 'border-color: black');
                var tdSeparatorCakrawala = document.createElement('th');
                tdSeparatorCakrawala.setAttribute('colspan','2');
                tdSeparatorCakrawala.innerHTML = 'Cakrawala Survey';
                trSeparatorCakrawala.appendChild(tdSeparatorCakrawala);
                body.appendChild(trSeparatorCakrawala);

                sobProductCakrawala.forEach(product => {
                    let tableRowProduct = document.createElement('tr');
                    tableRowProduct.setAttribute('data-category', product['Segment']);
                    var label = product['SOB - Variant Level'];
                    var filteredSelection = transactionCakrawalaFiltered.filter((dt) => dt['Id Pelanggan'] == custId);
                    var elmLabel = document.createElement('td');
                    elmLabel.innerHTML = label;
                    tableRowProduct.appendChild(elmLabel);
                    var elmValue = document.createElement('td');
                    var value = filteredSelection[0][label] ? (filteredSelection[0][label]).toLocaleString(numberFormat.region,
                        {
                            maximumFractionDigits: numberFormat.maxDecimalDigit,
                            minimumFractionDigits: numberFormat.minDecimalDigit,
                        },) : '0.0';
                    elmValue.innerHTML = value + ' packs';
                    tableRowProduct.appendChild(elmValue);
                    body.appendChild(tableRowProduct);
                });

                table.appendChild(header);
                table.appendChild(body);

                infowindow.setContent(table);
                infowindow.setPosition(feature.getGeometry().get());
                infowindow.open(map);
            }
            else if (type == 3 && feature.getGeometry().getType() == 'Point') {
                tableHead.innerText = "Store Category : INDOMARET";
                tableRow.appendChild(tableHead);
                header.appendChild(tableRow);

                var storeName = feature.getProperty('StoreName');
                var store = document.createElement('tr');
                store.id = storeName;
                var storeIdLabel = document.createElement('td');
                storeIdLabel.innerHTML = 'Store ID';
                var storeIdValue = document.createElement('td');
                storeIdValue.innerHTML = storeName;
                store.appendChild(storeIdLabel);
                store.appendChild(storeIdValue);
                body.appendChild(store);

                var filteredTransaction = transactionIdm.filter((data) => data['Store_Name'] == storeName);
                filteredTransaction.forEach(product => {
                    let tableRowProduct = document.createElement('tr');
                    tableRowProduct.setAttribute('data-category', product['Segment']);
                    var label = product['SKU'];
                    var elmLabel = document.createElement('td');
                    elmLabel.innerHTML = label + ' ASPD';
                    tableRowProduct.appendChild(elmLabel);
                    var elmValue = document.createElement('td');
                    var value = (product['Sales_Qty'] / 30).toLocaleString(numberFormat.region,
                        {
                            maximumFractionDigits: numberFormat.maxDecimalDigit,
                            minimumFractionDigits: numberFormat.minDecimalDigit,
                        }
                    );
                    elmValue.innerHTML = value + ' packs';
                    tableRowProduct.appendChild(elmValue);
                    body.appendChild(tableRowProduct);
                });

                table.appendChild(header);
                table.appendChild(body);

                infowindow.setContent(table);
                infowindow.setPosition(feature.getGeometry().get());
                infowindow.open(map);
            }
        }

        function filterVisual(layer, status) {
            layer.forEach(feature => {
                layer.overrideStyle(feature, {
                    visible: !status,
                });
            });
            return !status;
        }

        function calculateVolume5Week(squareArray, dataArray) {
            var result = new Array();
            var filteredSelection = new Array();
            var squareSegment;

            // filter transactional array and put into filteredSelection
            // output: filtered transactional array
            squareArray.forEach(square => {
                var sw = square.getGeometry().getAt(0).getAt(0);
                var ne = square.getGeometry().getAt(0).getAt(2);
                var bound = new google.maps.LatLngBounds(sw, ne);
                var squareSegment = square.getProperty(siteConfig.squareSegmentProperty);

                layerJTI.forEach(feature => {
                    if (bound.contains(feature.getGeometry().get())) {
                        var temp = dataArray.filter(data => data['CustomerId'] == feature.getProperty('szCustId'));
                        if (temp.length > 0) {
                            temp.forEach(dt => {
                                dt['SquareSegment'] = squareSegment;
                                filteredSelection.push(dt);
                            })
                        }
                    }
                });
            });

            // add new property named Category for segment category (SKM, SKT, SPM, etc.)
            filteredSelection.forEach(data => {
                var cat = lookup(jtiProduct, data['CategoryProduct'], 'KATEGORI PRODUK', 'Segment');
                data['Category'] = cat;
            });

            // Calculate each Category (SKM, SPM, SKT, etc.)
            squareSegmentationFilter.forEach(sqSegment => {
                categoryFilter.forEach(category => {
                    for (let index = 1; index <= 5; index++) {
                        var sum = 0;
                        var temp = filteredSelection.filter(data => data['Category'] == category && data['WeekNumber'] == index && data['SquareSegment'] == sqSegment);
                        if (temp.length > 0) {
                            temp.forEach(dt => {
                                sum += dt['Volume'];
                            })
                        }
                        result.push({ 'WeekNumber': index, 'squareSegment': sqSegment, 'category': category, 'volume': sum });
                    }
                });
            });

            return result;
        }

        function calculateDropSize5Week(squareArray, dataArray) {
            var result = new Array();
            var filteredSelection = new Array();
            var squareSegment;

            // filter transactional array and put into filteredSelection
            // output: filtered transactional array
            squareArray.forEach(square => {
                var sw = square.getGeometry().getAt(0).getAt(0);
                var ne = square.getGeometry().getAt(0).getAt(2);
                var bound = new google.maps.LatLngBounds(sw, ne);
                var squareSegment = square.getProperty(siteConfig.squareSegmentProperty);

                layerJTI.forEach(feature => {
                    if (bound.contains(feature.getGeometry().get())) {
                        var temp = dataArray.filter(data => data['CustomerId'] == feature.getProperty('szCustId'));
                        if (temp.length > 0) {
                            temp.forEach(dt => {
                                dt['SquareSegment'] = squareSegment;
                                filteredSelection.push(dt);
                            })
                        }
                    }
                });
            });

            // add new property named Category for segment category (SKM, SKT, SPM, etc.)
            filteredSelection.forEach(data => {
                var cat = lookup(jtiProduct, data['CategoryProduct'], 'KATEGORI PRODUK', 'Segment');
                data['Category'] = cat;
            });

            // Calculate each Category (SKM, SPM, SKT, etc.)
            squareSegmentationFilter.forEach(sqSegment => {
                categoryFilter.forEach(category => {
                    for (let index = 1; index <= 5; index++) {
                        var sum = 0;
                        var count = 0;
                        var ds = 0;
                        var temp = filteredSelection.filter(data => data['Category'] == category && data['WeekNumber'] == index && data['SquareSegment'] == sqSegment);
                        if (temp.length > 0) {
                            temp.forEach(dt => {
                                sum += dt['Volume'];
                                count += dt['EffectiveCall'];
                            })
                        }
                        ds = sum / count;
                        result.push({ 'WeekNumber': index, 'squareSegment': sqSegment, 'category': category, 'ds': ds });
                    }
                });
            });

            return result;
        }

        function calculateVolume(bound) {
            var result = new Array();
            var filteredSelection = new Array();
            layerJTI.forEach(feature => {
                if (bound.contains(feature.getGeometry().get())) {
                    var temp = transactionBosnet.filter(data => data['CustomerId'] == feature.getProperty('szCustId'));
                    if (temp.length > 0) {
                        temp.forEach(dt => {
                            filteredSelection.push(dt);
                        })
                    }
                }
            });

            filteredSelection.forEach(data => {
                var cat = lookup(jtiProduct, data['CategoryProduct'], 'KATEGORI PRODUK', 'Segment');
                data['Category'] = cat;
            });

            categoryFilter.forEach(category => {
                var sum = 0;
                var temp = filteredSelection.filter(data => data['Category'] == category);
                if (temp.length > 0) {
                    temp.forEach(dt => {
                        sum += dt['Volume'];
                    })
                }
                result.push({ 'category': category, 'volume': sum });
            });

            if (result.length > 0) {
                var sum = 0;
                result.forEach(data => {
                    sum += data['volume'];
                });
                result.push({ 'category': 'ALL', 'volume': sum });
            }

            return result;
        }

        function calculateDropSize(bound) {
            var result = new Array();
            var filteredSelection = new Array();
            layerJTI.forEach(feature => {
                if (bound.contains(feature.getGeometry().get())) {
                    var temp = transactionBosnet.filter(data => data['CustomerId'] == feature.getProperty('szCustId'));
                    if (temp.length > 0) {
                        temp.forEach(data => {
                            filteredSelection.push(data);
                        });
                    }
                }
            });

            filteredSelection.forEach(data => {
                var cat = lookup(jtiProduct, data['CategoryProduct'], 'KATEGORI PRODUK', 'Segment');
                data['Category'] = cat;
            });

            categoryFilter.forEach(category => {
                var sum = 0;
                var count = 0;
                var ds = 0;
                var temp = filteredSelection.filter(data => data['Category'] == category);
                if (temp.length > 0) {
                    temp.forEach(dt => {
                        sum += dt['Volume'];
                        count += dt['EffectiveCall'];
                    })
                }
                ds = sum / count;
                result.push({ 'category': category, 'volume': sum, 'ec': count, 'ds': ds });
            });

            if (result.length > 0) {
                var sum = 0;
                var count = 0;
                var ds = 0;
                result.forEach(data => {
                    sum += data['volume'];
                    count += data['ec'];
                });
                ds = sum / count;
                result.push({ 'category': 'ALL', 'volume': sum, 'ec': count, 'ds': ds });
            }

            return result;
        }

        function calculateGTstore(bound) {
            var count = 0;
            layerJTI.forEach(feature => {
                if (bound.contains(feature.getGeometry().get())) { count++; }
            });
            return count;
        }

        function calculateIDMStore(bound) {
            var count = 0;
            layerIdm.forEach(feature => {
                if (bound.contains(feature.getGeometry().get())) { count++; }
            });
            return count;
        }

        function calculateCakData(bound) {
            var result = new Array();
            var temp = new Array();
            layerJTI.forEach(feature => {
                if (bound.contains(feature.getGeometry().get())) {
                    var filteredSelection = transactionCakrawala.filter(data => data['Id Pelanggan'] == feature.getProperty('szCustId'));
                    if (filteredSelection.length > 0) { temp.push(filteredSelection[0]); }
                }
            });

            sobProductCakrawala.forEach(product => {
                var key = product['SOB - Variant Level'];
                var sum = 0;
                var count = 0;
                var average = 0;

                temp.forEach(dt => {

                    sum += dt[key];
                    count++;

                });
                average = sum / count;
                result.push({ 'product': key, 'total': average });
            });
            return result;
        }

        function resetPages() {
            volumeLink.parentElement.classList.remove('active');
            volumePage.classList.add('d-none');
            dropsizeLink.parentElement.classList.remove('active');
            dropsizePage.classList.add('d-none');
            ecLink.parentElement.classList.remove('active');
            ecPage.classList.add('d-none');
        }

        function initializeEventListener() {
            volumeLink.addEventListener('click', (e) => {
                resetPages();
                volumePage.classList.remove('d-none');
                volumeLink.parentElement.classList.add('active');
            });

            dropsizeLink.addEventListener('click', (e) => {
                resetPages();
                dropsizePage.classList.remove('d-none');
                dropsizeLink.parentElement.classList.add('active');
            });

            ecLink.addEventListener('click', (e) => {
                resetPages();
                ecPage.classList.remove('d-none');
                ecLink.parentElement.classList.add('active');
            });
            // Google Map Zoom Changes Listener
            map.addListener('zoom_changed', (e) => {
                if (map.getZoom() >= 16) {
                    elmAJTIStore.classList.remove("disabled");
                    elmAIDMStore.classList.remove("disabled");
                    elmAPoi.classList.remove("disabled");
                    elmABill.classList.remove("disabled");
                    if (!layerJTIStatus) {
                        elmAJTIStore.click();
                    }
                    if (!layerIdmStatus) {
                        elmAIDMStore.click();
                    }
                } else {
                    elmAJTIStore.classList.add("disabled");
                    elmAIDMStore.classList.add("disabled");
                    elmAPoi.classList.add("disabled");
                    elmABill.classList.add("disabled");
                    if (layerJTIStatus) {
                        elmAJTIStore.click();
                    }
                    if (layerIdmStatus) {
                        elmAIDMStore.click();
                    }
                    if (layerBillboardStatus) {
                        elmABill.click();
                    }
                    if (layerPoiStatus) {
                        elmAPoi.click();
                    }
                    if (infowindow.isOpen) {
                        infowindow.close();
                    }
                }
            });
        }

    </script>

    <script>/** ADDTIONAL FUNCTIONS **/
        function lookup(arr, id, src, target) {
            var result;
            arr.forEach((item) => {
                if (item[src] == id) {
                    result = item[target];
                } else {
                    return;
                }
            });
            return result;
        }

        async function loadDataToArray(fileLoc, fileType, geo = false, lat = "Latitude", lng = "Longitude", convert = 0) {
            if (geo) {
                if (fileType && fileType == 'xlsx') {
                    async function loadXlsxFile(fileLoc) {
                        const file = await (await fetch(fileLoc)).arrayBuffer();
                        var workbook = XLSX.readFile(file);
                        var sheet = workbook.Sheets[workbook.SheetNames[0]];
                        var rowObject = XLSX.utils.sheet_to_row_object_array(sheet);
                        return rowObject;
                    }
                    return convertToGeoJsonFromArray(await loadXlsxFile(fileLoc), lat, lng);
                } else if (fileType && fileType == 'json') {
                    let response = $.ajax({
                        url: fileLoc,
                        async: false,
                        dataType: "json",
                    });
                    if (response.status == 200) {
                        if (convert == 1) {
                            var data = response.responseJSON;
                            data.forEach(item => {
                                item[lat] = convertStringToNumber(item[lat]);
                                item[lng] = convertStringToNumber(item[lng]);
                            });
                            return convertToGeoJsonFromArray(await data, lat, lng);;
                        } else {
                            return convertToGeoJsonFromArray(await response.responseJSON, lat, lng);;
                        }
                    }
                } else {
                    let response = $.ajax({
                        url: fileLoc,
                        async: false,
                        dataType: "text",
                    });
                    if (response.status == 200) {
                        switch (fileType) {
                            case 'csv':
                                return responseTextToGeoJson(response.responseText);
                                break;

                            default:
                                return stringToArray(response.responseText);
                                break;
                        }
                    } else {
                        return false;
                    }
                }

            } else {
                if (fileType && fileType == 'json') {
                    let response = $.ajax({
                        url: fileLoc,
                        async: false,
                        dataType: "json",
                    });
                    return response.responseJSON;
                } else if (fileType && fileType == 'xlsx') {
                    async function loadXlsxFile(fileLoc) {
                        const file = await (await fetch(fileLoc)).arrayBuffer();
                        var workbook = XLSX.readFile(file);
                        var sheet = workbook.Sheets[workbook.SheetNames[0]];
                        var rowObject = XLSX.utils.sheet_to_row_object_array(sheet);
                        return rowObject;
                    }
                    return await loadXlsxFile(fileLoc);
                } else {
                    let response = $.ajax({
                        url: fileLoc,
                        async: false,
                        dataType: "text",
                    });
                    return stringToArray(response.responseText);
                }
            }

            function convertStringToNumber(string) {
                return Number(string);
            }

            /** PARSE ARRAY TO GEOJSON **/
            function convertToGeoJsonFromArray(array, latitude = "Latitude", longitude = "Longitude") {
                var output = {}
                output['type'] = 'FeatureCollection'
                var temp_array = []
                array.forEach(item => {
                    var temp = {}
                    temp['type'] = 'Feature'
                    temp['geometry'] = { "type": "Point", "coordinates": [item[longitude], item[latitude]] }
                    temp['properties'] = item
                    temp_array.push(temp)
                })
                output['features'] = temp_array;
                return output;
            }

            /* PARSE AJAX RESPONSE TEXT TO GEOJSON */
            function responseTextToGeoJson(data, latColumnName = "Latitude", longColumnName = "Longitude", type = 1) {
                var csvObject = Papa.parse(data.trim(), { dynamicTyping: true }).data;
                return GeoJSON.parse(
                    latLonColumnsToNumbers(massageData(csvObject), latColumnName, longColumnName),
                    {
                        Point: [latColumnName, longColumnName],
                    }
                );

            }

            /* TRANSFORM CSV TO ARRAY FOR GEOJSON */
            function massageData(text) {
                if (!text || !text.length) return null;
                var firstRow = text[0];
                var map = text.map(function (item) {
                    var returnItem = {},
                        i = 0;
                    firstRow.forEach(function (columnName) {
                        returnItem[columnName] = item[i++];
                    });
                    return returnItem;
                });
                map.shift();
                return map;
            }

            /* GEO JSON CONVERSION FUNCTION */
            function latLonColumnsToNumbers(data, latName, lonName) {
                return data.map(function (item) {
                    if (Object.hasOwn(item, "latname")) {
                        item[latName] = parseFloat(item[latName]);
                    }
                    if (Object.hasOwn(item, "lonName")) {
                        item[lonName] = parseFloat(item[lonName]);
                    }
                    return item;
                });
            }

            /* PARSE PLAIN TEXT RESPONSE TO ARRAY */
            function stringToArray(text) {
                let lines = text.split(/(?:\r\n|\n)+/).filter(function (el) { return el.length != 0 });
                let headers = lines.splice(0, 1)[0].split(csvDelimiter);
                let elements = [];
                for (var i = 0; i < lines.length; i++) {
                    let element = {};
                    let j = 0;
                    if (lines[i].match("\".*\"")) {
                        var value = lines[i].split(/((?:[^",]|(?:"(?:\\{2}|\\"|[^"])*?"))*)/g);
                        value = value.filter(a => a != ",");
                        value.shift();
                        for (var y = 0; y < headers.length; y++) {
                            if (value[y]) {
                                if (value[y].includes('\"\"')) {
                                    value[y] = value[y].replace(/\"\"/g, '');
                                }
                            }
                            element[headers[j]] = value[y];
                            j++;
                        }
                    } else {
                        var value = lines[i].split(csvDelimiter);
                        for (var y = 0; y < headers.length; y++) {
                            element[headers[j]] = value[y];
                            j++;
                        }
                    }
                    elements.push(element);
                }
                return elements;
            }

        }

    </script>

    <script>/** Load Google Maps API **/

        (g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => { await (a = m.createElement("script")); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps." + q); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; d[q] = f; a.onerror = () => h = n(Error(p + " could not load.")); a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a) })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)) })({
            key: mapConfig.API_KEY,
            v: "weekly",
            // Use the 'v' parameter to indicate the version to use (weekly, beta, alpha, etc.).
            // Add other bootstrap parameters as needed, using camel case.
        });

        async function initMap(callback) {
            // The location of Uluru
            const position = { lat: -25.344, lng: 131.031 };
            // Request needed libraries.
            //@ts-ignore
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
            const { LatLngBounds } = await google.maps.importLibrary("core");

            // The map, centered at Uluru
            map = new Map(document.getElementById("map"), {
                zoom: 8,
                center: { lat: mapConfig.COUNTRY_CENTER.latitude, lng: mapConfig.COUNTRY_CENTER.longitude },
                // mapId: "DEMO_MAP_ID",
                restriction: {
                    latLngBounds: mapConfig.COUNTRY_BOUNDS,
                    strictBounds: false,
                },
            });

            callback();
        }
    </script>

    <script>/** MAIN SCRIPT **/

        // Add additional scripts to HTML header
        // loadScript(siteConfig.siteResourceFolder.javascript + '/shp.js', 1);
        loadScript(siteConfig.siteResourceFolder.icon + '/min_logo-route-final-01.ico', 3);
        loadScript(siteConfig.siteResourceFolder.stylesheet + '/bootstrap.min.css', 2);
        loadScript(siteConfig.siteResourceFolder.javascript + '/bootstrap.bundle.min.js', 1);
        loadScript(siteConfig.siteResourceFolder.javascript + '/jquery.min.js', 1);
        loadScript(siteConfig.siteResourceFolder.javascript + '/GeoJson.js', 1);
        loadScript(siteConfig.siteResourceFolder.javascript + '/papaparse.min.js', 1);
        loadScript(siteConfig.siteResourceFolder.javascript + '/xlsx.full.min.js', 1);

        // Initialize variables
        let map;
        // let geoWorkplace;
        let layerWorkplaceBoundary;
        let layerWorkplaceBoundaryStatus = true;
        // let geoSquare;
        let layerSquareBoundary;
        let layerSquareBoundaryStatus = true;
        let geoPoi;
        let layerPoi;
        let layerPoiStatus = false;
        let geoIdm;
        let layerIdm;
        let layerIdmStatus = false;
        let geoBillboard;
        let layerBillboard;
        let layerBillboardStatus = false;
        let geoJTI;
        let layerJTI;
        let layerJTIStatus = false;

        let transactionBosnet;
        let transactionL4w;
        let transaction5Week;
        let transactionCakrawala;
        let transactionCakrawalaFiltered;
        let transactionIdm;
        let jtiProduct;
        let sobProduct;
        let sobProductIdm;
        let sobProductCakrawala;

        // Get url parameters
        var urlParams = new URLSearchParams(location.search);
        let wpCode = urlParams.get('wp') ? urlParams.get('wp') : dataSource._default.workPlace;

        // Variables for filters
        let squareSegmentationFilter = new Array();
        let elmSquareSegmentFilter = document.getElementById('squareSegmentItem');
        let squareIdFilter = new Array();
        let elmSquareIdFilter = document.getElementById('squareItem');
        let squareCategoryFilter = new Array();
        let elmSquareCategoryFilter = document.getElementById('squareCategoryItem');
        let workplaceFilter = new Array();
        let elmWorkplaceFilter = document.getElementById('clusterItem');
        let categoryFilter = new Array();
        let elmCategoryFilter = document.getElementById('categoryItem');

        // Variables for pages
        let volumeLink = document.getElementById(pages.volume.link);
        let volumePage = document.getElementById(pages.volume.page);
        let dropsizeLink = document.getElementById(pages.dropsize.link);
        let dropsizePage = document.getElementById(pages.dropsize.page);
        let ecLink = document.getElementById(pages.ec.link);
        let ecPage = document.getElementById(pages.ec.page);

        // Variables for Custom control
        let elmAJTIStore;
        let elmAIDMStore;
        let elmAPoi;
        let elmABill;

        // Variable for Charts
        var volumeChart = new Chart(volumePage);
        var dropSizeChart = new Chart(dropsizePage);
        var effectiveCallChart = new Chart(ecPage);

        // Variable for info window (pop-up).
        let infowindow;

        // Web Worker
        let loadWorker;
        let chartCalculationWorker;

        // Functions call 
        initMap(function () {
            const customControl = initCustomControl();
            map.controls[google.maps.ControlPosition.RIGHT_TOP].push(customControl);

            infowindow = new google.maps.InfoWindow({ headerDisabled: true, maxWidth: 500, });

            loadDataWorker();
            loadData(function () {
                infowindow = new google.maps.InfoWindow({ headerDisabled: true, maxWidth: 500, });
                initializeEventListener();
            });

        });


    </script>

</body>

</html>